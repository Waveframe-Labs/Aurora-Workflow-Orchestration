name: Build Kernel Packet (AWO)

on:
  workflow_dispatch:
    inputs:
      packet_version:
        description: "Semantic version for this packet (e.g. 1.0.0)"
        required: true
      include_drafts:
        description: "Include awokernel:true files even if filetype != core (1=yes, 0=no)"
        required: false
        default: "0"

jobs:
  build:
    name: Generate AWO Kernel Packet
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install tools
        run: |
          set -euo pipefail
          pip install jsonschema

      - name: Create output directory
        env:
          PACKDIR: kernel/outputs/${{ github.event.inputs.packet_version }}
        run: |
          set -euo pipefail
          mkdir -p "$PACKDIR"

      - name: Detect eligible kernel files
        id: detect
        env:
          INCLUDE_DRAFTS: ${{ github.event.inputs.include_drafts }}
        run: |
          set -euo pipefail
          # Find all files with awokernel: true metadata
          FILES="$(grep -rl '^awokernel: true' . | grep -E '\.(md|txt|json)$' || true)"

          if [ -z "$FILES" ]; then
            echo "::error::No files with 'awokernel: true' found."
            exit 1
          fi

          # If drafts are disabled, restrict to filetype: core
          if [ "${INCLUDE_DRAFTS}" != "1" ]; then
            FILES=$(printf '%s\n' $FILES | xargs -r grep -l '^filetype: core' | LC_ALL=C sort || true)
          else
            FILES=$(printf '%s\n' $FILES | LC_ALL=C sort)
          fi

          if [ -z "$FILES" ]; then
            echo "::error::No eligible kernel files after filtering (check filetype: core metadata)."
            exit 1
          fi

          {
            echo "files<<EOF"
            printf '%s\n' $FILES
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Copy files into packet
        env:
          PACKDIR: kernel/outputs/${{ github.event.inputs.packet_version }}
        run: |
          set -euo pipefail
          while IFS= read -r file; do
            mkdir -p "$PACKDIR/$(dirname "$file")"
            cp "$file" "$PACKDIR/$file"
          done <<< "${{ steps.detect.outputs.files }}"

      - name: Generate SHA256SUMS
        env:
          PACKDIR: kernel/outputs/${{ github.event.inputs.packet_version }}
        run: |
          set -euo pipefail
          cd "$PACKDIR"
          TMP_LIST="$(mktemp)"
          find . -type f ! -name 'SHA256SUMS.txt' -print | LC_ALL=C sort > "$TMP_LIST"
          : > SHA256SUMS.txt
          while IFS= read -r path; do
            sha256sum "$path" >> SHA256SUMS.txt
          done < "$TMP_LIST"
          rm -f "$TMP_LIST"

      - name: Build manifest
        env:
          PACKDIR: kernel/outputs/${{ github.event.inputs.packet_version }}
          PACKET_VERSION: ${{ github.event.inputs.packet_version }}
        run: |
          set -euo pipefail
          TEMPLATE="kernel/templates/manifest.template.json"
          if [ ! -f "$TEMPLATE" ]; then
            echo "::error::Template not found at $TEMPLATE"
            exit 1
          fi

          cp "$TEMPLATE" "$PACKDIR/MANIFEST.json"

          python << 'PYEOF'
          import json
          import datetime
          import os
          from pathlib import Path

          PACKDIR = os.environ["PACKDIR"]
          packet_version = os.environ["PACKET_VERSION"]

          manifest_path = Path(PACKDIR) / "MANIFEST.json"

          with manifest_path.open() as f:
              m = json.load(f)

          m["packet_version"] = packet_version
          m["generated_at"] = datetime.datetime.utcnow().isoformat() + "Z"

          sumfile = Path(PACKDIR) / "SHA256SUMS.txt"
          files = []
          with sumfile.open() as f:
              for line in f:
                  line = line.strip()
                  if not line:
                      continue
                  h, path = line.split(maxsplit=1)
                  files.append({"path": path, "hash": h})

          m["files"] = files

          with manifest_path.open("w") as f:
              json.dump(m, f, indent=2, sort_keys=True)
          PYEOF

      - name: Validate manifest
        run: |
          set -euo pipefail
          jsonschema -i kernel/outputs/${{ github.event.inputs.packet_version }}/MANIFEST.json kernel/schema/manifest.schema.json

      - name: Zip packet
        run: |
          set -euo pipefail
          cd kernel/outputs
          zip -r "kernel-pack-${{ github.event.inputs.packet_version }}.zip" "${{ github.event.inputs.packet_version }}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernel-pack-${{ github.event.inputs.packet_version }}
          path: kernel/outputs/kernel-pack-${{ github.event.inputs.packet_version }}.zip
