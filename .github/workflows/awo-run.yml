name: AWO Run (Manual Approve to Commit)

on:
  workflow_dispatch:
    inputs:
      workflow_file:
        description: "Workflow JSON path (relative to repo root)"
        required: true
        default: "workflows/multimodel.json"

permissions:
  contents: write

concurrency:
  group: awo-run
  cancel-in-progress: true

jobs:
  run_validate_upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Preflight (workflow exists + JSON valid)
        shell: bash
        run: |
          set -euo pipefail
          WF="${{ github.event.inputs.workflow_file }}"
          echo "[AWO] Using workflow: $WF"
          test -f "$WF" || { echo "::error::Workflow file not found: $WF"; exit 1; }
          sudo apt-get update && sudo apt-get install -y jq
          jq . "$WF" >/dev/null

      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install jsonschema

      - name: Run AWO
        id: runstep
        shell: bash
        run: |
          set +e
          python scripts/awo_run.py "${{ github.event.inputs.workflow_file }}"
          CODE=$?
          echo "RUNNER_EXIT_CODE=$CODE" >> "$GITHUB_ENV"
          # don't fail yet; we still want to capture/validate
          exit 0

      - name: Capture LAST_RUN
        id: cap
        shell: bash
        run: |
          set -euo pipefail
          if [[ ! -f runs/LAST_RUN ]]; then
            echo "::error::runs/LAST_RUN not found (runner may have failed before creating a run)."
            exit 1
          fi
          RID="$(tr -d '\n\r' < runs/LAST_RUN)"
          test -d "runs/${RID}" || { echo "::error::Run directory missing: runs/${RID}"; exit 1; }
          echo "run_dir=runs/${RID}" >> "$GITHUB_OUTPUT"
          echo "RID=${RID}" >> "$GITHUB_ENV"
          echo "[AWO] RUN_ID=${RID}"

      - name: Validate run_manifest.json and provenance.json
        env:
          RUN_DIR: ${{ steps.cap.outputs.run_dir }}
        shell: bash
        run: |
          set -euo pipefail
          echo '
import json, os, sys, pathlib
from jsonschema import Draft202012Validator

run_dir = pathlib.Path(os.environ["RUN_DIR"]).resolve()
schemas = pathlib.Path("schemas").resolve()

def load(p):
    with open(p, "r", encoding="utf-8") as f:
        return json.load(f)

man = load(run_dir / "run_manifest.json")
prov = load(run_dir / "provenance.json")
man_schema = load(schemas / "run_manifest.schema.json")
prov_schema = load(schemas / "provenance.schema.json")

Draft202012Validator(man_schema).validate(man)
if not isinstance(prov, list):
    print(f"::error file={run_dir}/provenance.json,line=1::provenance.json must be a list")
    sys.exit(2)
for i, rec in enumerate(prov):
    Draft202012Validator(prov_schema).validate(rec)
print("Schema validation OK")
' > validate.py
          python validate.py

      - name: Upload run artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: awo-run-${{ env.RID }}
          path: |
            ${{ steps.cap.outputs.run_dir }}/run_manifest.json
            ${{ steps.cap.outputs.run_dir }}/provenance.json
            ${{ steps.cap.outputs.run_dir }}/workflow_frozen.json
            ${{ steps.cap.outputs.run_dir }}/report.md
            ${{ steps.cap.outputs.run_dir }}/steps
            ${{ steps.cap.outputs.run_dir }}/artifacts

      - name: Exit with pending when gate triggered
        shell: bash
        run: |
          if [[ "${RUNNER_EXIT_CODE:-0}" == "78" ]]; then
            echo "::notice::Run is pending human review (audit gate)."
            exit 0
          fi
    
