name: Root SHA256SUMS

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate root SHA256SUMS.txt
        run: |
          set -eu
          cd "$GITHUB_WORKSPACE"

          tmpfile="$(mktemp)"
          : > "$tmpfile"

          # Include docs PDFs and MDs
          if [ -d docs ]; then
            find docs -type f \( -name '*.pdf' -o -name '*.md' \) -print0 \
              | sort -z | xargs -0 sha256sum >> "$tmpfile" || true
          fi

          # Include everything under runs/ (but NOT runs_legacy/)
          if [ -d runs ]; then
            find runs -type f -print0 | sort -z | xargs -0 sha256sum >> "$tmpfile"
          fi

          # Include top-level core files if present
          for f in README.md CHANGELOG.md CITATION.cff LICENSE LICENSE-CC-BY-4.0.md; do
            [ -f "$f" ] && sha256sum "$f" >> "$tmpfile" || true
          done

          # Include any other top-level .md (besides README.md already handled)
          for f in *.md; do
            [ "$f" = "README.md" ] && continue
            [ -f "$f" ] && sha256sum "$f" >> "$tmpfile"
          done

          # Sort deterministically by path and write final file
          sort -k2,2 "$tmpfile" > SHA256SUMS.txt
          rm "$tmpfile"

      - name: Commit SHA256SUMS.txt
        run: |
          set -eu
          if git diff --quiet SHA256SUMS.txt; then
            echo "No changes to SHA256SUMS.txt"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add SHA256SUMS.txt
          git commit -m "chore: update root SHA256SUMS.txt"
          git push
