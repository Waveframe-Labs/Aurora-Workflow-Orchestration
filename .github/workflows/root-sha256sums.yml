name: Build root SHA256SUMS

on:
  workflow_dispatch: {}   # run manually from Actions tab

permissions:
  contents: write         # needed to commit SHA256SUMS.txt

concurrency:
  group: root-sha256sums
  cancel-in-progress: false

jobs:
  build-root-sha:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate SHA256SUMS.txt (root)
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar nullglob

          # Assemble the file list (ordered, deterministic).
          files=(
            docs/**/*.pdf
            docs/**/*.md
            decisions/**/*.md
            README.md
            CHANGELOG.md
            CITATION.cff
            COMPLIANCE.md
            SECURITY.md
            LICENSE
            LICENSE-CC-BY-4.0.md
            LICENSE.md
            figures/**/*.{png,jpg,jpeg,svg,pdf}
            runs/**/approval.json
            runs/**/report.md
            runs/**/workflow_frozen.json
            runs/**/manifest.md
            runs/**/manifest.json
            runs/**/SHA256SUMS.txt
            logs/governance/**/*.md
            logs/attestation_failures/**/*.md
          )

          # Build the list, excluding runs_legacy and any non-existent globs.
          tmplist=$(mktemp)
          > "$tmplist"
          for f in "${files[@]}"; do
            for g in $f; do
              # Skip if it lives under runs_legacy/
              [[ "$g" == runs_legacy/* ]] && continue
              [[ -f "$g" ]] && printf '%s\0' "$g" >> "$tmplist"
            done
          done

          # Sort deterministically and hash.
          if [[ -s "$tmplist" ]]; then
            tr '\0' '\n' < "$tmplist" | LC_ALL=C sort -u | \
              xargs -I{} -r sha256sum "{}" > SHA256SUMS.txt
          else
            echo "No files matched; not overwriting SHA256SUMS.txt" >&2
            exit 1
          fi

      - name: Show summary
        run: |
          head -n 25 SHA256SUMS.txt || true
          echo "---"
          echo "Total lines:" $(wc -l < SHA256SUMS.txt)

      - name: Commit and push if changed
        shell: bash
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if ! git diff --quiet -- SHA256SUMS.txt; then
            git add SHA256SUMS.txt
            git commit -m "Update root SHA256SUMS.txt (automated)"
            git push
          else
            echo "No changes to SHA256SUMS.txt"
          fi
