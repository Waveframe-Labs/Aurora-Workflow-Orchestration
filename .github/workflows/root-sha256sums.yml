name: Build root SHA256SUMS

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-hashes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Generate SHA256SUMS.txt
        shell: bash
        run: |
          set -euxo pipefail
          OUT="SHA256SUMS.txt"
          TMP="$(mktemp)"
          shopt -s globstar nullglob dotglob

          echo "Collecting files..."
          > "$TMP.files"
          for pat in \
            "docs/**/*.md" "docs/**/*.pdf" \
            "decisions/**/*.md" \
            "runs/**/*.md" "runs/**/*.json" "runs/**/*.yml" \
            "README.md" "CHANGELOG.md" "COMPLIANCE.md" "CITATION.cff" \
            "LICENSE" "LICENSE-CC-BY-4.0.md" "SECURITY.md" \
            ; do
            for f in $pat; do
              [[ -d "$f" ]] && continue
              [[ "$f" == runs_legacy/* ]] && continue
              echo "$f" >> "$TMP.files"
            done
          done

          sort -u "$TMP.files" -o "$TMP.files"

          > "$OUT"
          if [[ -s "$TMP.files" ]]; then
            while IFS= read -r f; do
              sha256sum "$f" >> "$OUT"
            done < "$TMP.files"
          else
            echo "# No eligible files found to hash" >> "$OUT"
          fi

          echo "SHA256SUMS.txt preview:"
          wc -l "$OUT" || true
          head -n 20 "$OUT" || true

      - name: Commit & push if changed
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A SHA256SUMS.txt

          if git diff --cached --quiet; then
            echo "No staged changes (SHA256SUMS.txt identical)."
            exit 0
          fi

          git commit -m "Update root SHA256SUMS.txt (automated)"
          git push
