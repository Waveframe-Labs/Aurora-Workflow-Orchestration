name: Build root SHA256SUMS

on:
  push:
    paths-ignore:
      - "SHA256SUMS.txt"
      - ".github/workflows/root-sha256sums.yml"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: root-sha256sums
  cancel-in-progress: false

jobs:
  build-hashes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Generate SHA256SUMS.txt
        shell: bash
        run: |
          set -euo pipefail

          rm -f SHA256SUMS.txt

          # Exact coverage hashing (CRI-compliant)
          find . -type f \
            ! -path "./.git/*" \
            ! -path "./SHA256SUMS.txt" \
            ! -path "./.github/workflows/root-sha256sums.yml" \
            -print0 | sort -z | xargs -0 sha256sum > SHA256SUMS.txt

          echo "Total files hashed: $(wc -l < SHA256SUMS.txt)" >> $GITHUB_STEP_SUMMARY

      - name: Skip commit if unchanged
        id: diff
        shell: bash
        run: |
          if git diff --quiet -- "$GITHUB_WORKSPACE/SHA256SUMS.txt"; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit & push
        if: steps.diff.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update root SHA256SUMS.txt"
          file_pattern: SHA256SUMS.txt
          push_options: "--force-with-lease"
