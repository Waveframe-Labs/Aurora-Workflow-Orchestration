name: Build root SHA256SUMS

on:
  push:
    paths:
      - 'docs/**.md'
      - 'docs/**.pdf'
      - 'decisions/**'
      - 'runs/**'
      - 'README.md'
      - 'CHANGELOG.md'
      - 'CITATION.cff'
      - 'COMPLIANCE.md'
      - 'LICENSE*'
      - 'SECURITY.md'
      - '.github/workflows/root-sha256sums.yml'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: root-sha256sums
  cancel-in-progress: false

jobs:
  build-hashes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Generate SHA256SUMS.txt
        shell: bash
        run: |
          set -euxo pipefail
          OUT="SHA256SUMS.txt"
          TMP="$(mktemp)"
          shopt -s globstar nullglob dotglob

          > "$TMP.files"
          for pat in \
            docs/**/*.md docs/**/*.pdf \
            decisions/**/*.md \
            runs/**/*.md runs/**/*.json runs/**/*.yml \
            README.md CHANGELOG.md COMPLIANCE.md CITATION.cff \
            LICENSE LICENSE-CC-BY-4.0.md SECURITY.md
          do
            for f in $pat; do
              [[ -d "$f" ]] && continue
              [[ "$f" == runs_legacy/* ]] && continue
              echo "$f" >> "$TMP.files"
            done
          done

          sort -u "$TMP.files" -o "$TMP.files"

          > "$OUT"
          if [[ -s "$TMP.files" ]]; then
            while IFS= read -r f; do
              sha256sum "$f" >> "$OUT"
            done < "$TMP.files"
          else
            echo "# No eligible files found to hash" >> "$OUT"
          fi

          echo "Lines in SHA256SUMS.txt: $(wc -l < "$OUT")" >> $GITHUB_STEP_SUMMARY

      - name: Skip commit if unchanged
        id: diff
        shell: bash
        run: |
          if git diff --quiet -- "$GITHUB_WORKSPACE/SHA256SUMS.txt"; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit & push
        if: steps.diff.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update root SHA256SUMS.txt"
          file_pattern: SHA256SUMS.txt
